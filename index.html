<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—¥ãƒ—æ–°ä¸–ç•Œ æŠ•ç¥¨æ äº¤æ›ãƒ¡ãƒ¼ã‚«ãƒ¼</title>

<style>
  :root{
    --bg:#f6f6f6;
    --card:#ffffff;
    --line:#e6e6e6;
    --text:#111;
    --muted:#666;
    --shadow: 0 4px 14px rgba(0,0,0,.06);
    --radius:14px;

    /* â˜…ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆå…¨å“¡å…±é€šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ï¼‰ */
    --accent:#0080ff;

    /* æ—¢å­˜äº’æ›ï¼šä»Šã¾ã§ --blue ã‚’ä½¿ã£ã¦ãŸã®ã§ã€ã“ã“ã§é€£å‹• */
    --blue: var(--accent);

    /* ç”»é¢å´ */
    --slot: 86px;
    --gap:  14px;

    /* ä¿å­˜ç”»åƒå´ï¼šJSãŒâ€œå°‘ã—ã ã‘â€è‡ªå‹•èª¿æ•´ */
    --exAvatar: 112px;
    --exBorder: 8px;
    --exGapX: 56px;
    --exGapY: 30px;
    --exName: 15px;

    /* ä¿å­˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè‡ªå‹•èª¿æ•´ç”¨ */
    --exTopH: 470px;
    --exBottomPadTop: 16px;
    --exBottomPadBottom: 150px; /* å®‰å…¨åœ°å¸¯ */
    --exMissTop: 18px;

    /* â˜…ç©ºãæ ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚ºã‚’JSã§å¯å¤‰ï¼ˆè¢«ã‚Šé˜²æ­¢ï¼‰ */
    --exMissSize: 120px;
    --exMissRowMinH: 130px;
    --exMissGapY: 12px;

    /* â˜…@æ–‡å­—ã‚µã‚¤ã‚ºï¼ˆå…¨å“¡çµ±ä¸€ãƒ»JSã§èª¿æ•´ï¼‰ */
    --exHandle: 13px;

    /* â˜…ä¸‹ã®ã€Œâ—¯æŠ•ç¥¨æ  ç©ºã„ã¦ã„ã¾ã™ã€æ–‡å­—ã‚µã‚¤ã‚ºï¼ˆè¢«ã‚Šé˜²æ­¢ã§JSãŒèª¿æ•´ï¼‰ */
    --exSentence: 20px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
  }
  .topbar{ padding: 12px 12px 10px; max-width: 980px; margin: 0 auto; }
  h1{margin:0;font-size:20px;line-height:1.2}

  main{max-width:980px;margin:0 auto;padding:12px;}
  .card{
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* ===== ç”»é¢è¡¨ç¤ºãƒãƒŠãƒ¼ ===== */
  .banner{
    height: 110px;
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    background:
      radial-gradient(circle at 20% 30%, rgba(255,120,200,.30), transparent 40%),
      radial-gradient(circle at 80% 40%, rgba(120,160,255,.28), transparent 45%),
      linear-gradient(135deg, #ffe7f4, #eef3ff);
  }
  .banner.hasImage{ background-size: cover; background-position: center; }
  .banner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
    pointer-events:none;
  }
  .bannerTitle{
    position:relative;
    font-weight: 900;
    letter-spacing: .06em;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(255,255,255,.9);
    font-size: 14px;
    z-index: 2;
    white-space: nowrap;
  }
  .slotBadge{
    position:absolute;
    right: 12px;
    bottom: 12px;
    background: rgba(0,128,255,.92);
    color: #fff;
    font-weight: 900;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 14px;
    box-shadow: 0 8px 18px rgba(0,0,0,.14);
    z-index: 5;
    white-space: nowrap;
    pointer-events:none;
  }

  /* ===== ä¸Šï¼šé¸æŠæ  ===== */
  .picksWrap{
    padding: 12px 14px 8px;
    background-image: url("https://i.imgur.com/lFGbXfI.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .picksRow{
    display:flex;
    justify-content:center;
    gap: var(--gap);
    flex-wrap: wrap;
    row-gap: 14px;
    padding: 12px 0 10px;
  }
  .slot{ width: var(--slot); text-align:center; }

  .avatar{
    width: var(--slot);
    height: var(--slot);
    border-radius:999px;
    border: 5px solid var(--blue);
    background:#fff;
    overflow: visible;
    box-shadow: 0 8px 18px rgba(0,0,0,.10);
    margin: 0 auto;
    position:relative;
    z-index: 1;
  }
  .avatar img{
    width:100%;
    height:100%;
    border-radius:999px;
    object-fit: cover;
    object-position: 50% 35%;
    display:block;
    image-rendering: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  .rank{
    position:absolute;
    left:50%;
    bottom:-12px;
    transform: translateX(-50%);
    background: var(--blue);
    color:#fff;
    border-radius:999px;
    font-weight:900;
    font-size: 9px;
    padding: 6px 8px;
    line-height:1;
    min-width: 2.0em;
    text-align:center;
    z-index: 2;
    box-shadow: 0 6px 14px rgba(0,0,0,.18);
    pointer-events:none;
  }
  .name{
    margin-top: 14px;
    font-size: 12px;
    font-weight: 900;
    line-height: 1.1;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .empty .avatar{
    opacity:.16;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 34px;
    font-weight: 900;
    color:#555;
  }
  .empty .rank{display:none;}
  .empty .name{display:none;}

  /* â˜…æ åˆ¥ã‚«ãƒ©ãƒ¼ï¼šä»Šé¸ã‚“ã§ã‚‹æ ã‚’åˆ†ã‹ã‚Šã‚„ã™ã */
  .slot.colorTarget .avatar{
    outline: 4px solid rgba(0,0,0,.12);
    outline-offset: 3px;
  }

  .reorder{ display:none; gap:10px; justify-content:center; margin-top: 8px; }
  body.reorder-on .reorder{ display:flex; }
  .reorder button{
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 16px;
    line-height: 1;
  }

  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    padding: 10px 10px 12px;
    border-top: 1px solid #f1f1f1;
    background:#fff;
  }
  button{
    padding: 11px 12px;
    border-radius: 12px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 14px;
  }
  button:active{transform:scale(.98)}
  .primary{border-color:#cfe2ff;}
  .danger{border-color:#ffd6d6;}
  .mode{border-color:#e7e7e7;}

  /* TikTokèª˜å°ï¼ˆã‚µã‚¤ãƒˆä¸Šï¼‰ */
  .tiktokBtn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding: 11px 14px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 900;
    text-decoration: none;
    color: #fff;
    background: linear-gradient(135deg, #000000, #222222);
    border: 1px solid #111;
    box-shadow: 0 6px 14px rgba(0,0,0,.18);
  }
  .tiktokBtn:active{ transform: scale(.98); }
  .tiktokHint{
    margin-top: 6px;
    font-size: 13px;
    font-weight: 900;
    color: #555;
    text-align: center;
    letter-spacing: .02em;
  }
  .tiktokWrap{ display:flex; flex-direction:column; align-items:center; }

  /* â˜…ç©ºãæ ãƒœã‚¿ãƒ³ */
  .freeControl{ display:flex; flex-direction:column; align-items:center; gap:6px; }
  .freeLabel{ font-size:12px; font-weight:900; color:#666; }
  .freeBtns{
    display: grid;
    grid-template-columns: repeat(5, 44px);
    gap: 8px;
    justify-content: center;
  }
  .freeBtnActive{ border-color:#cfe2ff; background:#eef6ff; font-weight: 1000; }

  /* â˜…ä¸¸æ ã‚«ãƒ©ãƒ¼å¤‰æ›´UI */
  .colorControl{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    padding: 2px 6px;
  }
  .palette{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
  }
  .colorSwatch{
    width: 30px;
    height: 30px;
    border-radius: 999px;
    border: 2px solid rgba(0,0,0,.10);
    box-shadow: 0 6px 14px rgba(0,0,0,.10);
    cursor:pointer;
    background: #000;
  }
  .colorSwatch.active{
    outline: 3px solid rgba(0,0,0,.12);
    border-color: rgba(0,0,0,.25);
    transform: scale(1.03);
  }
  .colorPicker{
    width: 40px;
    height: 30px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0;
    background:#fff;
  }

  /* ===== ä¸€è¦§ï¼š2åˆ—ãƒœã‚¿ãƒ³ ===== */
  .listCard{
    margin-top: 12px;
    padding: 10px;
    background-image: url("https://i.imgur.com/lUMY5QA.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .sectionTitle{
    font-size: 18px;
    font-weight: 900;
    padding: 6px 2px 10px;
    color: #fff;
    text-shadow: 0 2px 6px rgba(0,0,0,0.35);
  }

  .searchRow{ display:flex; gap:10px; align-items:center; margin-bottom: 10px; }
  .search{
    flex:1;
    display:flex;
    align-items:center;
    border:1px solid #ddd;
    border-radius: 12px;
    padding: 10px 12px;
    background:#fff;
  }
  .search input{ border:none; outline:none; width:100%; font-size: 15px; background:transparent; }
  #membersWrap{
    max-height: 52vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    border-top:1px solid #f1f1f1;
    padding-top: 6px;
    overscroll-behavior: contain;
  }
  .membersGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:12px;
    padding: 10px 6px 6px;
  }
  .memberCard{
    border: 1px solid #e8e8e8;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 4px 14px rgba(0,0,0,.06);
    padding: 12px 10px 10px;
    cursor:pointer;
    user-select:none;
    text-align:center;
    position:relative;
  }
  .memberCard:active{ transform:scale(.99); }

  .memberCardThumb{
    width:100%;
    aspect-ratio: 1 / 1;
    border-radius: 14px;
    overflow:hidden;
    background:#f7f7f7;
    border:1px solid #f0f0f0;
    position: relative; /* â˜…è¾é€€ãƒ©ãƒ™ãƒ«ç”¨ */
  }
  .memberCardThumb img{
    width:100%;
    height:100%;
    object-fit: cover;
    object-position: 50% 20%;
    display:block;
    image-rendering: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  .memberCardName{ margin-top:10px; font-weight:900; font-size:14px; line-height:1.2; }
  .memberCardSub{ margin-top:4px; font-size:12px; color: var(--muted); }
  .memberCard.selected{ opacity:.35; filter: grayscale(1); pointer-events:none; }
  .memberCardProfile{
    position:absolute;
    right:10px;
    top:10px;
    font-size:12px;
    font-weight:900;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid #cfe2ff;
    color: var(--blue);
    background: rgba(255,255,255,.92);
    text-decoration:none;
    line-height:1;
  }

  /* â˜…è¾é€€ï¼šã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‹é¸æŠä¸å¯ï¼‹å†™çœŸä¸Šã«è¡¨ç¤º */
  .memberCard.withdrawn{
    opacity: .45;
    filter: grayscale(1);
    cursor: default;
  }
  .memberCard.withdrawn:active{ transform:none; }
  .withdrawnBadge{
    position: absolute;
    left: 10px;
    top: 10px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(0,0,0,.08);
    font-weight: 1000;
    font-size: 12px;
    color: #111;
    box-shadow: 0 8px 18px rgba(0,0,0,.10);
  }
  .memberCard.withdrawn .memberCardProfile{ opacity:.65; }

  .toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: rgba(0,0,0,.78);
    color:#fff;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    display:none;
    z-index:999;
  }

  /* ===== ä¿å­˜å°‚ç”¨ï¼ˆ1004Ã—1040ï¼‰ ===== */
  #exportArea{
    position: fixed;
    left: -10000px;
    top: 0;
    width: 1004px;
    height: 1040px;
    background: #ffffff;
    overflow: hidden;
  }
  #exportInner{
    width: 1004px;
    height: 1040px;
    position: relative;
    background:#fff;
    overflow:hidden;
    background-image: url("https://i.imgur.com/lFGbXfI.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* ãƒãƒŠãƒ¼ */
  .exportBanner{
    height: 150px;
    background-size: cover;
    background-position: center;
    position:relative;
  }
  .exportBanner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
    pointer-events:none;
  }
  .exportTitlePill{
    position:absolute;
    left:50%;
    top: 50%;
    transform: translate(-50%,-50%);
    font-weight: 900;
    letter-spacing: .06em;
    padding: 12px 20px;
    border-radius: 999px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(255,255,255,.92);
    font-size: 20px;
    color:#111;
    white-space: nowrap;
    z-index: 2;
  }
  .exportCredit{
    position:absolute;
    top: 18px;
    right: 22px;
    font-size: 14px;
    font-weight: 900;
    color: rgba(0,0,0,.55);
    background: rgba(255,255,255,.72);
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.85);
    z-index: 120;
    backdrop-filter: blur(6px);
    pointer-events:none;
  }

  /* â˜…å¤‰æ›´ï¼šä¸‹å›ºå®šï¼ˆå·¦ä¸‹ TikTok / å³ä¸‹ #ï¼‰ã‚’â€œé«˜ç´šã‚¬ãƒ©ã‚¹â€ã« */
  .exportTikTok,
  .exportHashtag{
    position:absolute;
    bottom: 14px;
    z-index: 120;
    pointer-events:none;
    white-space: nowrap;

    background: linear-gradient(135deg,
      rgba(255,255,255,.72),
      rgba(255,255,255,.42)
    );
    border: 1px solid rgba(255,255,255,.55);
    border-bottom-color: rgba(255,255,255,.32);
    border-right-color: rgba(255,255,255,.32);

    backdrop-filter: blur(12px) saturate(155%);
    -webkit-backdrop-filter: blur(12px) saturate(155%);

    box-shadow:
      0 14px 30px rgba(0,0,0,.14),
      inset 0 1px 0 rgba(255,255,255,.75),
      inset 0 -1px 0 rgba(255,255,255,.18);

    border-radius: 999px;
    padding: 8px 12px;

    color: rgba(10,10,10,.88);
    font-weight: 1000;
    text-shadow:
      0 1px 0 rgba(255,255,255,.70),
      0 0 6px rgba(255,255,255,.22);

    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
  }
  .exportTikTok::before,
  .exportHashtag::before{
    content:"";
    position:absolute;
    inset: 1px;
    border-radius: 999px;
    background: linear-gradient(
      135deg,
      rgba(255,255,255,.55),
      rgba(255,255,255,0) 55%
    );
    pointer-events:none;
    mix-blend-mode: screen;
    opacity: .55;
  }
  .exportTikTok{
    left: 18px;
    font-size: 14px;
  }
  .exportHashtag{
    right: 18px;
    font-size: 13px;
    letter-spacing: .03em;
  }

  /* ãƒœãƒ‡ã‚£ */
  .exportBody{
    height: calc(1040px - 150px);
    padding: 18px 56px 0;
  }

  /* â˜…ã€ŒæŠ•ç¥¨ã—ã¦æ¬²ã—ã„ãƒ¡ãƒ³ãƒãƒ¼ã€æ¶ˆã—ãŸã®ã§ã€ä½™ç™½ã‚’è©°ã‚ã‚‹ */
  .exportTop{
    height: var(--exTopH);
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    align-items:center;
    padding-top: 6px;
  }
  .exportRows{
    width: 100%;
    display:flex;
    flex-direction:column;
    gap: var(--exGapY);
    align-items:center;
    margin-top: 8px;
  }
  .exportRow{
    display:flex;
    justify-content:center;
    gap: var(--exGapX);
    width: 100%;
  }

  .exportSlot{
    width: calc(var(--exAvatar) + 90px);
    text-align:center;
  }
  .exportAvatar{
    width: var(--exAvatar);
    height: var(--exAvatar);
    border-radius:999px;
    border: var(--exBorder) solid var(--blue);
    overflow: visible;
    background:#fff;
    margin: 0 auto;
    box-shadow: 0 10px 22px rgba(0,0,0,.10);
    position:relative;
  }
  .exportPhoto{
    width:100%;
    height:100%;
    border-radius:999px;
    background-size: cover;
    background-position: 50% 35%;
    background-repeat: no-repeat;
    image-rendering: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  .exportRank{
    position:absolute;
    left:50%;
    bottom:-14px;
    transform: translateX(-50%);
    background: var(--blue);
    color:#fff;
    border-radius:999px;
    font-weight:900;
    font-size: 12px;
    padding: 7px 10px;
    line-height:1;
    min-width: 2.2em;
    text-align:center;
    box-shadow: 0 8px 16px rgba(0,0,0,.18);
    pointer-events:none;
  }
  .exportName{
    margin-top: 16px;
    font-size: var(--exName);
    font-weight: 900;
    line-height: 1.15;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }

  /* â˜…@è¡¨ç¤ºï¼ˆä¸‹æ®µã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«å¿…ãš1è¡Œåˆ†ã®é«˜ã•ç¢ºä¿ï¼‰ */
  .exportHandle{
    margin-top: 6px;
    font-size: var(--exHandle);
    font-weight: 900;
    color: rgba(0,0,0,.55);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.1;
    height: calc(var(--exHandle) * 1.1);
  }

  /* ä¸‹ï¼šç©ºãæ ã‚¨ãƒªã‚¢ */
  .exportBottom{
    height: calc(1040px - 150px - var(--exTopH));
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding-top: var(--exBottomPadTop);
    padding-bottom: var(--exBottomPadBottom);
  }

  .exportSlotsText{
    text-align:center;
    font-size: 26px;
    font-weight: 1000;
    color: var(--blue);
    background: rgba(255,255,255,.95);
    border: 4px solid var(--blue);
    border-radius: 999px;
    padding: 10px 22px;
    letter-spacing: .04em;
    white-space: nowrap;
    box-shadow: 0 8px 18px rgba(0,128,255,.25);
  }

  .exportMissingRows{
    margin-top: var(--exMissTop);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: var(--exMissGapY);
  }
  .exportMissingRow{
    display:flex;
    justify-content:center;
    gap: 28px;
    min-height: var(--exMissRowMinH);
  }

  /* æœªé¸æŠã‚¢ã‚¤ã‚³ãƒ³ */
  .missingIcon{
    width: var(--exMissSize);
    height: var(--exMissSize);
    background: #82cded;

    -webkit-mask-image: url("https://i.imgur.com/nAiYU1V.png");
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-position: center;
    -webkit-mask-size: contain;

    mask-image: url("https://i.imgur.com/nAiYU1V.png");
    mask-repeat: no-repeat;
    mask-position: center;
    mask-size: contain;

    border-radius: 12px;
    box-shadow: 0 10px 22px rgba(0,0,0,.12);
  }

  /* â˜…ä¸‹ã®æ–‡ã¯ã€Œæ–‡å­—ã ã‘ã€ */
  .exportSlotsSentence{
    margin-top: 12px;
    text-align:center;
    font-size: var(--exSentence);
    font-weight: 900;
    color: rgba(10,10,10,.86);
    letter-spacing: .04em;
    white-space: nowrap;
    text-shadow:
      0 1px 0 rgba(255,255,255,.65),
      0 0 6px rgba(255,255,255,.18);
  }

  /* ===== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ¯å›è¡¨ç¤ºï¼‰ ===== */
  .introModal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 18px;
  }
  .introModal.show{ display:flex; }

  .introBox{
    width: min(520px, 92vw);
    background: #fff;
    border-radius: 18px;
    border: 1px solid rgba(0,0,0,.08);
    box-shadow: 0 20px 50px rgba(0,0,0,.25);
    overflow: hidden;
    position: relative;
  }
  .introHead{
    padding: 14px 16px 10px;
    font-weight: 1000;
    font-size: 16px;
    border-bottom: 1px solid #f0f0f0;
    background: rgba(248,248,248,.9);
  }
  .introBody{
    padding: 16px;
    font-size: 14px;
    line-height: 1.7;
    font-weight: 800;
    color: #111;
    white-space: pre-line;
  }
  .introCloseBtn{
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid #d7e8ff;
    background: #eef6ff;
    color: #0066cc;
    font-weight: 1000;
    font-size: 14px;
  }
  .introCloseBtn:active{ transform: scale(.98); }

  /* ===== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—2ãƒšãƒ¼ã‚¸ï¼‹ã‚¬ãƒ©ã‚¹é¢¨ ===== */
  .introBox.glass{
    position: relative;
    background: linear-gradient(135deg, rgba(255,255,255,.82), rgba(255,255,255,.48));
    border-radius: 18px;
    overflow: hidden;
    box-shadow:
      0 22px 60px rgba(0,0,0,.28),
      inset 0 1px 0 rgba(255,255,255,.75),
      inset 0 -1px 0 rgba(255,255,255,.18);
    border: 1px solid rgba(255,255,255,.38);
    backdrop-filter: blur(12px) saturate(155%);
    -webkit-backdrop-filter: blur(12px) saturate(155%);
  }
  .introBox.glass::before{
    content:"";
    position:absolute;
    left:-20%;
    top:-30%;
    width:140%;
    height:60%;
    background: linear-gradient(135deg, rgba(255,255,255,.65), rgba(255,255,255,0) 55%);
    transform: rotate(-6deg);
    pointer-events:none;
    opacity:.55;
  }
  .introBox.glass::after{
    content:"";
    position:absolute;
    inset:0;
    background-image: radial-gradient(rgba(0,0,0,.06) 1px, transparent 1px);
    background-size: 3px 3px;
    opacity:.12;
    mix-blend-mode: overlay;
    pointer-events:none;
  }
  .introBox.glass .introHead{
    background: rgba(255,255,255,.55);
    border-bottom: 1px solid rgba(0,0,0,.06);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .introBox.glass .introBody{
    position: relative;
    padding: 0;
    overflow: hidden;
    min-height: 190px;
    white-space: normal;
  }
  .introPage{
    white-space: pre-line;
    font-size: 14px;
    line-height: 1.7;
    font-weight: 800;
    color: #111;

    position: absolute;
    left: 16px;
    right: 16px;
    top: 16px;
    bottom: 16px;

    opacity: 0;
    transform: translateX(14px);
    transition: opacity .28s ease, transform .32s cubic-bezier(.2,.8,.2,1);
    pointer-events: none;
  }
  .introPage.isActive{
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
  }

  .introFooter{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    padding: 12px 12px 14px;
    border-top: 1px solid rgba(0,0,0,.06);
    background: rgba(255,255,255,.55);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: relative;
    z-index: 3;
  }

  .supportBtn{
    text-decoration:none;
    font-weight:1000;
    font-size: 13px;
    padding: 10px 12px;
    border-radius: 999px;
    color: rgba(10,10,10,.88);
    background: linear-gradient(135deg, rgba(255,255,255,.72), rgba(255,255,255,.40));
    border: 1px solid rgba(255,255,255,.45);
    box-shadow:
      0 12px 26px rgba(0,0,0,.16),
      inset 0 1px 0 rgba(255,255,255,.70);
    backdrop-filter: blur(12px) saturate(155%);
    -webkit-backdrop-filter: blur(12px) saturate(155%);
    white-space: nowrap;
  }
  .supportBtn:active{ transform: scale(.98); }

  @keyframes pulseGlow{
    0%   { box-shadow: 0 12px 26px rgba(0,0,0,.16), 0 0 0 0 rgba(0,128,255,.22), inset 0 1px 0 rgba(255,255,255,.70); }
    60%  { box-shadow: 0 12px 26px rgba(0,0,0,.16), 0 0 0 10px rgba(0,128,255,0), inset 0 1px 0 rgba(255,255,255,.70); }
    100% { box-shadow: 0 12px 26px rgba(0,0,0,.16), 0 0 0 0 rgba(0,128,255,0), inset 0 1px 0 rgba(255,255,255,.70); }
  }
  .pulse{ animation: pulseGlow 2.2s ease-in-out infinite; }

  .pager{
    display:flex;
    align-items:center;
    gap: 10px;
    user-select:none;
  }
  .pagerBtn{
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.45);
    background: linear-gradient(135deg, rgba(255,255,255,.72), rgba(255,255,255,.40));
    box-shadow: 0 10px 22px rgba(0,0,0,.12);
    backdrop-filter: blur(12px) saturate(155%);
    -webkit-backdrop-filter: blur(12px) saturate(155%);
    font-weight: 1000;
  }
  .pagerBtn:active{ transform: scale(.98); }

  .pagerCenter{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-width: 56px;
  }
  .pagerText{
    font-weight: 1000;
    font-size: 12px;
    color: rgba(0,0,0,.70);
    line-height: 1.1;
  }
  .dots{
    margin-top: 4px;
    display:flex;
    gap: 6px;
  }
  .dot{
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: rgba(0,0,0,.22);
  }
  .dot.isOn{ background: rgba(0,0,0,.55); }

  .glassBtn{
    background: linear-gradient(135deg, rgba(255,255,255,.72), rgba(255,255,255,.40));
    border: 1px solid rgba(255,255,255,.45);
    box-shadow:
      0 10px 24px rgba(0,0,0,.16),
      inset 0 1px 0 rgba(255,255,255,.70);
    backdrop-filter: blur(12px) saturate(155%);
    -webkit-backdrop-filter: blur(12px) saturate(155%);
  }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <h1>æ—¥ãƒ—æ–°ä¸–ç•Œ æŠ•ç¥¨æ äº¤æ›ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  </div>
</header>

<main>
  <div class="card" id="picksCard">
    <div id="banner" class="banner">
      <div class="bannerTitle">æ—¥ãƒ—æ–°ä¸–ç•Œ æŠ•ç¥¨æ äº¤æ›ãƒ¡ãƒ¼ã‚«ãƒ¼</div>
      <div class="slotBadge" id="slotBadge">ç©ºã 0 æ </div>
    </div>

    <div class="picksWrap" id="picksWrap">
      <div class="picksRow" id="picksRow"></div>
    </div>

    <div class="actions">
      <button class="primary" type="button" onclick="saveImage()">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
      <button type="button" onclick="undo()">1äººæˆ»ã™</button>
      <button class="danger" type="button" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="mode" type="button" id="reorderBtn" onclick="toggleReorder()">ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šOFF</button>

      <!-- â˜…ä¸¸æ ã‚«ãƒ©ãƒ¼å¤‰æ›´ï¼šå…¨å“¡/æ åˆ¥åˆ‡æ›¿ -->
      <div class="colorControl">
        <button class="mode" id="colorModeBtn" type="button" onclick="toggleColorMode()">è‰²å¤‰æ›´ï¼šå…¨å“¡</button>

        <div class="palette" id="palette">
          <div class="colorSwatch" data-color="#0080ff" style="background:#0080ff" title="ãƒ–ãƒ«ãƒ¼" onclick="setAccentColor('#0080ff')"></div>
          <div class="colorSwatch" data-color="#ff4fa3" style="background:#ff4fa3" title="ãƒ”ãƒ³ã‚¯" onclick="setAccentColor('#ff4fa3')"></div>
          <div class="colorSwatch" data-color="#7a5cff" style="background:#7a5cff" title="ãƒ‘ãƒ¼ãƒ—ãƒ«" onclick="setAccentColor('#7a5cff')"></div>
          <div class="colorSwatch" data-color="#23c16b" style="background:#23c16b" title="ã‚°ãƒªãƒ¼ãƒ³" onclick="setAccentColor('#23c16b')"></div>
          <div class="colorSwatch" data-color="#ff8a00" style="background:#ff8a00" title="ã‚ªãƒ¬ãƒ³ã‚¸" onclick="setAccentColor('#ff8a00')"></div>
          <div class="colorSwatch" data-color="#111111" style="background:#111111" title="ãƒ–ãƒ©ãƒƒã‚¯" onclick="setAccentColor('#111111')"></div>
          <input class="colorPicker" id="colorPicker" type="color" value="#0080ff" onchange="setAccentColor(this.value)" title="è‡ªç”±ã«é¸ã¶" />
        </div>
      </div>

      <div class="tiktokWrap">
        <a class="tiktokBtn" href="https://www.tiktok.com/@12agassi" target="_blank" rel="noopener">TikTokãƒ•ã‚©ãƒ­ãƒ¼ãŠé¡˜ã„ğŸ¥¹</a>
        <div class="tiktokHint">â†‘ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
      </div>

      <!-- â˜…ç©ºãæ ãƒœã‚¿ãƒ³ï¼ˆ1ã€œ10ï¼‰ -->
      <div class="freeControl">
        <div class="freeLabel">ç©ºãæ </div>
        <div class="freeBtns" id="freeBtns">
          <button type="button" class="mode freeBtn" data-n="1" onclick="setFreeSlots(1)">1</button>
          <button type="button" class="mode freeBtn" data-n="2" onclick="setFreeSlots(2)">2</button>
          <button type="button" class="mode freeBtn" data-n="3" onclick="setFreeSlots(3)">3</button>
          <button type="button" class="mode freeBtn" data-n="4" onclick="setFreeSlots(4)">4</button>
          <button type="button" class="mode freeBtn" data-n="5" onclick="setFreeSlots(5)">5</button>
          <button type="button" class="mode freeBtn" data-n="6" onclick="setFreeSlots(6)">6</button>
          <button type="button" class="mode freeBtn" data-n="7" onclick="setFreeSlots(7)">7</button>
          <button type="button" class="mode freeBtn" data-n="8" onclick="setFreeSlots(8)">8</button>
          <button type="button" class="mode freeBtn" data-n="9" onclick="setFreeSlots(9)">9</button>
          <button type="button" class="mode freeBtn" data-n="10" onclick="setFreeSlots(10)">10</button>
        </div>
      </div>
    </div>
  </div>

  <div class="listCard">
    <div class="sectionTitle">ä¸€è¦§ï¼ˆæŠ¼ã—ã¦è¿½åŠ ï¼‰</div>
    <div class="searchRow">
      <div class="search">
        <input id="search" type="text" placeholder="Search" oninput="drawMembers()" />
      </div>
      <button class="mode" id="toggleListBtn" type="button" onclick="toggleCandidates(event)">ç·´ç¿’ç”Ÿå€™è£œ</button>
    </div>

    <div id="membersWrap">
      <div id="members" class="membersGrid"></div>
    </div>
  </div>
</main>

<div class="toast" id="toast">ç”»åƒã‚’ç”Ÿæˆä¸­â€¦</div>

<!-- ä¿å­˜å°‚ç”¨ -->
<div id="exportArea" aria-hidden="true">
  <div id="exportInner">
    <div class="exportCredit">created by @12agassi</div>

    <div id="exportBanner" class="exportBanner">
      <div class="exportTitlePill">æ—¥ãƒ—æ–°ä¸–ç•Œ æŠ•ç¥¨æ äº¤æ›ãƒ¡ãƒ¼ã‚«ãƒ¼</div>
    </div>

    <div class="exportBody">
      <div class="exportTop">
        <div class="exportRows">
          <div class="exportRow" id="exportRow1"></div>
          <div class="exportRow" id="exportRow2"></div>
        </div>
      </div>

      <div class="exportBottom" id="exportBottom">
        <div class="exportSlotsText" id="exportSlotsText">ç©ºã 0 æ </div>

        <div class="exportMissingRows" id="exportMissingRows">
          <div class="exportMissingRow" id="exportMissingRow1"></div>
          <div class="exportMissingRow" id="exportMissingRow2"></div>
        </div>

        <div class="exportSlotsSentence" id="exportSlotsSentence">0 æŠ•ç¥¨æ  ç©ºã„ã¦ã„ã¾ã™</div>
      </div>
    </div>

    <div class="exportTikTok" id="exportTikTok">TikTok:12agassi</div>
    <div class="exportHashtag" id="exportHashtag">#æ—¥ãƒ—æ–°ä¸–ç•ŒæŠ•ç¥¨æ äº¤æ›ãƒ¡ãƒ¼ã‚«ãƒ¼</div>
  </div>
</div>

<!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ¯å›è¡¨ç¤ºãƒ»2ãƒšãƒ¼ã‚¸ï¼‰ -->
<div class="introModal" id="introModal" aria-hidden="true">
  <div class="introBox glass" role="dialog" aria-modal="true" aria-labelledby="introTitle">

    <div class="introHead" id="introTitle">ã“ã®ãƒ¡ãƒ¼ã‚«ãƒ¼ã«ã¤ã„ã¦</div>

    <div class="introBody" id="introBody">
      <div class="introPage isActive" data-page="1">
ã“ã®ãƒ¡ãƒ¼ã‚«ãƒ¼ã¯ã€SNSã«ã¦æŠ•ç¥¨æ ã‚’
äº¤æ›ã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ç”»åƒã‚’ä½œæˆã§ãã¾ã™ã€‚

æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚‚ç¢ºèªã—ã¦ã­ğŸ™‡ğŸ»â€â™€ï¸
      </div>

      <div class="introPage" data-page="2">
è¿½åŠ ã—ãŸç·´ç¿’ç”Ÿã‚’æŠ¼ã™ã¨
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥ã‚Œã‚Œã‚‹ã‚ˆâœ¨
ï¼ˆæ—¢ã«æ ã‚’äº¤æ›ã—ãŸäººã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å…¥ã‚Œã¦ã­ï¼‰

ã€ãŠé¡˜ã„ã€‘Tiktokã‚‚ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ä¸‹ã•ã„ğŸ¥º
      </div>
    </div>

    <div class="introFooter">
      <a class="supportBtn pulse" href="https://www.tiktok.com/@12agassi" target="_blank" rel="noopener">
        ã‚ãŒã£ã—ã‚’å¿œæ´ã™ã‚‹
      </a>

      <div class="pager" aria-label="ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ">
        <button class="pagerBtn" type="button" onclick="introPrev()">â—€ï¸</button>

        <div class="pagerCenter">
          <div class="pagerText" id="pagerText">1/2</div>
          <div class="dots" id="pagerDots" aria-hidden="true">
            <span class="dot isOn"></span>
            <span class="dot"></span>
          </div>
        </div>

        <button class="pagerBtn" type="button" onclick="introNext()">â–¶ï¸</button>
      </div>

      <button class="introCloseBtn glassBtn" type="button" onclick="closeIntro()">é–‰ã˜ã‚‹</button>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const HEADER_IMAGE_URL = "https://i.imgur.com/nYBRUdd.png";
const FALLBACK_IMG = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

/* â˜…é¸æŠã§ãã‚‹ä¸Šé™ï¼ˆè¡¨ç¤ºã®ï¼‹æ ç”¨ï¼‰ */
const MAX_SELECTED = 11;

const STORAGE_KEY  = "oshivote_selected_v6";
const FREE_SLOTS_KEY = "oshivote_free_slots_v1";

/* â˜…å…¨ä½“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ä¸¸æ ã‚«ãƒ©ãƒ¼ä¿å­˜ */
const ACCENT_COLOR_KEY = "oshivote_accent_color_v1";

/* â˜…è¿½åŠ ï¼šæ ã”ã¨ã®è‰²ä¿å­˜ */
const SLOT_COLORS_KEY = "oshivote_slot_colors_v1";
let slotColors = loadSlotColors();   // { traineeIndex: "#rrggbb", ... }

/* â˜…è¿½åŠ ï¼šè‰²å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨å“¡/æ åˆ¥ï¼‰ */
let perSlotColorMode = false;
let colorTargetPos = null; // selectedé…åˆ—ä¸Šã®ä½ç½®ï¼ˆ0..selected.length-1ï¼‰

/* â˜…@ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¿å­˜ */
const HANDLES_KEY = "oshivote_handles_v1";
let handles = loadHandles();

let showingCandidates = false;

/* â˜…ç©ºãæ ã¯æ‰‹å‹• */
let freeSlots = loadFreeSlots();

/* â˜…è¾é€€è€…ID */
const WITHDRAWN_IDS = new Set([
  "horieito",      // ç·´ç¿’ç”Ÿï¼šä¿é‡Œç‘›éƒ½
  "sakuraihikaru"  // å€™è£œï¼šæ«»äº•è¼
]);

/* ===== è‰²ç³» å…±é€š ===== */
function normalizeHexColor(c){
  if(!c) return "#0080ff";
  c = String(c).trim();
  if(/^#[0-9a-fA-F]{3}$/.test(c)){
    return "#" + c[1]+c[1] + c[2]+c[2] + c[3]+c[3];
  }
  if(/^#[0-9a-fA-F]{6}$/.test(c)) return c.toLowerCase();
  return "#0080ff";
}

/* å…¨å“¡å…±é€šè‰²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
function loadAccentColor(){
  try{
    const v = localStorage.getItem(ACCENT_COLOR_KEY);
    return normalizeHexColor(v);
  }catch(e){
    return "#0080ff";
  }
}
function saveAccentColor(color){
  try{ localStorage.setItem(ACCENT_COLOR_KEY, normalizeHexColor(color)); }catch(e){}
}
function updatePaletteUI(color){
  const c = normalizeHexColor(color);
  const swatches = document.querySelectorAll(".colorSwatch");
  swatches.forEach(el=>{
    const d = normalizeHexColor(el.getAttribute("data-color"));
    el.classList.toggle("active", d === c);
  });
  const picker = document.getElementById("colorPicker");
  if(picker) picker.value = c;
}
function applyAccentColor(color){
  const c = normalizeHexColor(color);
  document.documentElement.style.setProperty("--accent", c);
  updatePaletteUI(c);
}

/* æ åˆ¥è‰² */
function loadSlotColors(){
  try{
    const raw = localStorage.getItem(SLOT_COLORS_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){ return {}; }
}
function saveSlotColors(){
  try{ localStorage.setItem(SLOT_COLORS_KEY, JSON.stringify(slotColors)); }catch(e){}
}
function getColorForTraineeIndex(ti){
  const c = slotColors[String(ti)];
  return c ? normalizeHexColor(c) : loadAccentColor(); // æœªè¨­å®šãªã‚‰å…¨ä½“è‰²
}
function setColorForTraineeIndex(ti, color){
  slotColors[String(ti)] = normalizeHexColor(color);
  saveSlotColors();
}

/* â˜…å…¨å“¡/æ åˆ¥ åˆ‡æ›¿ */
function toggleColorMode(){
  perSlotColorMode = !perSlotColorMode;
  colorTargetPos = null;

  const btn = document.getElementById("colorModeBtn");
  if(btn) btn.textContent = "è‰²å¤‰æ›´ï¼š" + (perSlotColorMode ? "æ åˆ¥" : "å…¨å“¡");

  // æ åˆ¥ã«å…¥ã£ãŸã‚‰ã€ã¾ãšã¯å…¨ä½“è‰²ã‚’ãƒ‘ãƒ¬ãƒƒãƒˆã«è¡¨ç¤º
  updatePaletteUI(loadAccentColor());
  drawPicks();
}

/* â˜…æ åˆ¥ãƒ¢ãƒ¼ãƒ‰ã§ã€è‰²ã‚’ä»˜ã‘ãŸã„æ ã‚’é¸ã¶ */
function setColorTarget(pos){
  if(!perSlotColorMode) return;
  if(pos < 0 || pos >= selected.length) return;
  colorTargetPos = pos;

  const ti = selected[pos];
  updatePaletteUI(getColorForTraineeIndex(ti)); // ãã®æ ã®è‰²ã‚’ãƒ‘ãƒ¬ãƒƒãƒˆã«åæ˜ 
  drawPicks();
}

/* â˜…ã‚«ãƒ©ãƒ¼å¤‰æ›´ï¼ˆæ åˆ¥ãªã‚‰å¯¾è±¡æ ã€å…¨å“¡ãªã‚‰å…±é€šè‰²ï¼‰ */
function setAccentColor(color){
  const c = normalizeHexColor(color);

  // æ åˆ¥ãƒ¢ãƒ¼ãƒ‰ã§å¯¾è±¡æ ãŒã‚ã‚‹ãªã‚‰ã€ãã®æ ã ã‘å¤‰ãˆã‚‹
  if(perSlotColorMode && colorTargetPos !== null && colorTargetPos < selected.length){
    const ti = selected[colorTargetPos];
    setColorForTraineeIndex(ti, c);
    updatePaletteUI(c);
    drawPicks();
    drawExportPicks();
    return;
  }

  // é€šå¸¸ï¼ˆå…¨å“¡å…±é€šï¼‰
  saveAccentColor(c);
  applyAccentColor(c);
  drawPicks();
  drawExportPicks();
}

function profileUrlById(id){
  if(!id) return "https://produce101.jp/profile/detail/?lang=ja";
  return "https://produce101.jp/profile/detail/?id=" + encodeURIComponent(id) + "&lang=ja";
}
function displayName(full){
  return (full || "").replace(/\s*\([^)]*\)\s*/g, "").trim();
}
function alphaPart(full){
  const m = (full||"").match(/\(([^)]*)\)/);
  return m ? "(" + m[1] + ")" : "";
}
function withMembersScrollLock(fn){
  const wrap = document.getElementById("membersWrap");
  const prev = wrap ? wrap.scrollTop : 0;
  fn();
  requestAnimationFrame(() => { if(wrap) wrap.scrollTop = prev; });
}

/* â˜…@èª­ã¿æ›¸ã */
function loadHandles(){
  try{
    const raw = localStorage.getItem(HANDLES_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){ return {}; }
}
function saveHandles(){
  try{ localStorage.setItem(HANDLES_KEY, JSON.stringify(handles)); }catch(e){}
}
/* â˜…é¸æŠæ ã‚¿ãƒƒãƒ—ã§ @å…¥åŠ›ï¼ˆæ åˆ¥ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯æ é¸æŠã«ãªã‚‹ï¼‰ */
function editHandle(pos){
  if(pos < 0 || pos >= selected.length) return;
  const traineeIndex = selected[pos];
  const current = (handles[String(traineeIndex)] || "").trim();

  let next = prompt("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ã­ï¼ˆä¾‹ï¼š@xxxxï¼‰", current || "@");
  if(next === null) return;
  next = String(next || "").trim();

  if(!next){
    delete handles[String(traineeIndex)];
    saveHandles();
    drawExportPicks();
    return;
  }
  if(next[0] !== "@") next = "@" + next;

  handles[String(traineeIndex)] = next;
  saveHandles();
  drawExportPicks();
}

/* ====== ç·´ç¿’ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆç·´ç¿’ç”Ÿï¼‹å€™è£œï¼‰ ====== */
const traineesOnly = [
  {name:"ã‚¢ãƒ€ãƒ ãƒ»ãƒŠã‚¬ã‚¤(ADAM)", img:"https://i.imgur.com/6QGzvRx.png", id:"adamnagai"},
  {name:"ä¸­ä¸¸ æ™å¯¿(AJU)", img:"https://i.imgur.com/KiZCKos.png", id:"nakamaruaju"},
  {name:"ã‚ªãƒ ãƒ»ã‚¹ã‚¢ãƒ³ã‚«ãƒ¯ãƒ¼ãƒ†ãƒ³(AOM)", img:"https://i.imgur.com/dDIFJSc.png", id:"aomsuungkavathin"},
  {name:"ã‚¢ãƒ¼ãƒãƒ£ãƒ¼ãƒ»ã‚¦ã‚¤(ARCHER)", img:"https://i.imgur.com/5iIerqN.png", id:"archeruy"},
  {name:"ç¯ ãƒ¶è°· æ­©å¤¢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png", id:"shinogayaayumu"},
  {name:"å°æ— åƒæ‚Ÿ(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png", id:"kobayashichisato"},
  {name:"åŠ è—¤ å¤§æ¨¹ (K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png", id:"katodaiki"},
  {name:"ã‚«ã‚¯ãƒ»ãƒ‰ãƒ³ãƒŸãƒ³(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png", id:"kwakdongmin"},
  {name:"æœ«å· ç‘›å¤ª(EITA)", img:"https://i.imgur.com/alEjKCP.png", id:"suekawaeita"},
  {name:"ä¿é‡Œ ç‘›éƒ½(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png", id:"horieito"}, /* â˜…è¾é€€ */
  {name:"é‡‘ç”° æ „éƒ½(K.EITO)", img:"https://i.imgur.com/tF7i1du.png", id:"kanedaeito"},
  {name:"æ«»äº• æ¥“çœŸ(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png", id:"sakuraifuma"},
  {name:"å°ç¬ åŸã‚¸ãƒ¥ã‚¼ãƒƒãƒšæ…§(GIUSEPPE)", img:"https://i.imgur.com/2oKn3Ma.jpeg", id:"ogasawaragiuseppekei"},
  {name:"å€‰æ©‹ å¾æ§™(GOTEN)", img:"https://i.imgur.com/hlEjYqR.png", id:"kurahashigoten"},
  {name:"å €å°¾ è–(HIJIRI)", img:"https://i.imgur.com/5Qb5dRJ.png", id:"horiohijiri"},
  {name:"ç‘æ…¶è¦§ å¤ªéƒ½(HIROTO)", img:"https://i.imgur.com/siOPGIr.png", id:"zukeranhiroto"},
  {name:"ãƒ¦ãƒ»ãƒ’ãƒ§ãƒ³ã‚¹ãƒ³(HYEONSEUNG)", img:"https://i.imgur.com/lY3lXLj.png", id:"yoohyeonseung"},
  {name:"å²¡ç”° å½ªå¾(HYUGO)", img:"https://i.imgur.com/zalwc1W.png", id:"okadahyugo"},
  {name:"æŸ³è°· ä¼Šå†´(ISSA)", img:"https://i.imgur.com/gboCNWu.png", id:"yanagiyaissa"},
  {name:"ãƒ¦ãƒ³ãƒ»ã‚¸ã‚§ãƒ¨ãƒ³(JAEYONG)", img:"https://i.imgur.com/1yCImxd.png", id:"yoonjaeyong"},
  {name:"ã‚¸ãƒ¥ã‚¢ãƒ³ãƒ»ã‚¸ã‚§ã‚¤(JAY)", img:"https://i.imgur.com/41jKNZX.png", id:"chuangjay"},
  {name:"ä¸¸å°¾ å°‹ä¸€éƒ(JINICHIRO)", img:"https://i.imgur.com/83azYjx.png", id:"maruojinichiro"},
  {name:"æ²³é‚Š æ™Ÿ(JOE)", img:"https://i.imgur.com/DqUS1o6.png", id:"kawabejoe"},
  {name:"ã‚·ãƒ³ãƒ»ã‚¸ãƒ§ãƒ³ã‚¦ã‚¯(JUNGUK)", img:"https://i.imgur.com/6cwEusK.jpeg", id:"shinjunguk"},
  {name:"é‡‘å®‰ ç´”æ­£(JUNSEI)", img:"https://i.imgur.com/juPhMDR.png", id:"kaneyasujunsei"},
  {name:"å®‡é‡ æµ·å¤¢(KAIMU)", img:"https://i.imgur.com/QVliSyD.png", id:"unokaimu"},
  {name:"å¤šæ¯” å¥è–(KANADE)", img:"https://i.imgur.com/rdSJ6QX.png", id:"tabikanade"},
  {name:"æ¨ªå±± å¥å¤¢(KANAME)", img:"https://i.imgur.com/0brlEw8.png", id:"yokoyamakaname"},
  {name:"é–¢ æ•¬æ¬¡éƒ(KEIJIRO)", img:"https://i.imgur.com/PHlkDUt.png", id:"sekikeijiro"},
  {name:"é«™æ¾ æ•¬ç¥(KEISUKE)", img:"https://i.imgur.com/bs4vfiF.png", id:"takamatsukeisuke"},
  {name:"å°é‡ æ…¶äºº(KEITO)", img:"https://i.imgur.com/glfmRJE.png", id:"onokeito"},
  {name:"è¥¿å±± è³¢äºº(KENTO)", img:"https://i.imgur.com/izEXoBY.png", id:"nishiyamakento"},
  {name:"æ²³åˆ æ™ƒèª (KOSEI)", img:"https://i.imgur.com/E30eGfr.png", id:"kawaikosei"},
  {name:"ç…§äº• åº·ç¥(KOSUKE)", img:"https://i.imgur.com/oDkwdFn.png", id:"teruikosuke"},
  {name:"æµ…é¦™ å­å¤ªéƒ(KOTARO)", img:"https://i.imgur.com/7eJxl8o.png", id:"asakakotaro"},
  {name:"é«™è°· äº¬å¹³(KYOHEI)", img:"https://i.imgur.com/CLU1cPO.png", id:"takayakyohei"},
  {name:"ç”°ä¸­ è’”(MAKI)", img:"https://i.imgur.com/No6Nybr.png", id:"tanakamaki"},
  {name:"å±±æ ¹ æ­¦è”µ(MUSASHI)", img:"https://i.imgur.com/Ou2XuDa.png", id:"yamanemusashi"},
  {name:"åœŸç”° å¤®ä¿®(OSUKE)", img:"https://i.imgur.com/Xs0WjIn.png", id:"tsuchidaosuke"},
  {name:"å €é‡ è“®(H.REN)", img:"https://i.imgur.com/FQEx0JM.png", id:"horinoren"},
  {name:"å°æ¸…æ°´ è“®(KO.REN)", img:"https://i.imgur.com/S8Ij9OZ.png", id:"koshimizuren"},
  {name:"ãƒã‚§ãƒ³ãƒ»ãƒªãƒƒã‚­ãƒ¼(RICKEY)", img:"https://i.imgur.com/DnnZVAT.png", id:"chenrickey"},
  {name:"ç¥å…ƒ ç†ä¸˜(RIKU)", img:"https://i.imgur.com/jwJ9CLd.png", id:"kamimotoriku"},
  {name:"é³©å ´ é™¸äºº(H.RIKUTO)", img:"https://i.imgur.com/JdCFbCb.png", id:"hatobarikuto"},
  {name:"ä»Šæ±Ÿ é™¸æ–—(I.RIKUTO)", img:"https://i.imgur.com/jiZZwJu.png", id:"imaerikuto"},
  {name:"ç”²æ– é™¸ä¹Ÿ(RIKUYA)", img:"https://i.imgur.com/lfiqB2f.png", id:"kairikuya"},
  {name:"å¤§ç€¬ å‡œå’Œ(RINTO)", img:"https://i.imgur.com/OT0UHId.png", id:"ohserinto"},
  {name:"ä¸Šé‡ ç‰å‰(U.RUI)", img:"https://i.imgur.com/36XqMd9.png", id:"uenorui"},
  {name:"é£¯å¡š äº®è³€(RYOGA)", img:"https://i.imgur.com/ExbaI6W.png", id:"iizukaryoga"},
  {name:"çŸ³ç”° äº®å¤ª(RYOTA)", img:"https://i.imgur.com/Ctw95jF.png", id:"ishidaryota"},
  {name:"å²¡æˆ¸ ç«œèŠ½(RYUGA)", img:"https://i.imgur.com/gyPHKjY.png", id:"okadoryuga"},
  {name:"æ‰å±± ç«œå¸(RYUJI)", img:"https://i.imgur.com/NeB980M.png", id:"sugiyamaryuji"},
  {name:"é¦™æœˆ èª å¤ª(SEITA)", img:"https://i.imgur.com/def6F6u.png", id:"katsukiseita"},
  {name:"æ¾¤äº• æ˜Ÿå(SENA)", img:"https://i.imgur.com/Dpzzr9K.png", id:"sawaisena"},
  {name:"ã‚ªãƒ»ã‚·ãƒ³ãƒ˜ãƒ³(SHINHAENG)", img:"https://i.imgur.com/LH673dA.png", id:"ohshinhaeng"},
  {name:"å²©åŸ æ…äºŒ(SHINJI)", img:"https://i.imgur.com/h5rDvjC.png", id:"iwakishinji"},
  {name:"å®®å´ çœŸä½‘(SHINSUKE)", img:"https://i.imgur.com/xJuj9wW.png", id:"miyazakishinsuke"},
  {name:"è¥¿ï¨‘ æŸŠ(N.SHU)", img:"https://i.imgur.com/OZrHFUX.png", id:"nishizakishu"},
  {name:"å±±ä¸‹ æŸŠ(Y.SHU)", img:"https://i.imgur.com/642IX8o.png", id:"yamashitashu"},
  {name:"ãƒ‘ã‚¯ãƒ»ã‚·ãƒ¨ãƒ³(SIYOUNG)", img:"https://i.imgur.com/wSokxJh.png", id:"parksiyoung"},
  {name:"ä½è—¤ ç¢§ç©º (S.SORA)", img:"https://i.imgur.com/yF4WJJB.png", id:"satosora"},
  {name:"æ±é‡ è’¼æ±°(SOTA)", img:"https://i.imgur.com/GvLpwfo.png", id:"tonosota"},
  {name:"è—¤ç‰§ å¤§é›…(F.TAIGA)", img:"https://i.imgur.com/4G2hBRy.png", id:"fujimakitaiga"},
  {name:"æ¾ç”° å¤ªé›…(M.TAIGA)", img:"https://i.imgur.com/tICsJFs.png", id:"matsudataiga"},
  {name:"é‡‘å€‰ æ‹“æœª(TAKUMI)", img:"https://i.imgur.com/O3gluG7.png", id:"kanakuratakumi"},
  {name:"ç†Šéƒ¨ æ‹“æ–—(K.TAKUTO)", img:"https://i.imgur.com/NaQURc7.png", id:"kumabetakuto"},
  {name:"å®®é‡Œ æ‹“åˆ©(M.TAKUTO)", img:"https://i.imgur.com/5B8NMyF.png", id:"miyazatotakuto"},
  {name:"å—å¹³ é”çŸ¢(TATSUYA)", img:"https://i.imgur.com/jHnmGTs.png", id:"minamihiratatsuya"},
  {name:"æ£®äº• è¼(TERU)", img:"https://i.imgur.com/SAo1Rs4.png", id:"moriiteru"},
  {name:"åŒ—æ— å¤©è™(TETORA)", img:"https://i.imgur.com/2gCwqHF.png", id:"kitabayashitetora"},
  {name:"è—¤èŠ³ è¾°å¼¥(TOKIYA)", img:"https://i.imgur.com/9prpjvI.png", id:"fujiyoshitokiya"},
  {name:"å¢—ç”° å€«å¸Œ(TOMOKI)", img:"https://i.imgur.com/4JSh3HD.png", id:"masudatomoki"},
  {name:"æ¿±ç”° æ°¸é (TOWA)", img:"https://i.imgur.com/Yap9beM.png", id:"hamadatowa"},
  {name:"ã‚¢ã‚®ãƒŠãƒ«ãƒ‰ãƒ»ãƒˆãƒªã‚¹ã‚¿ãƒ³ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚¹(TRISTAN)", img:"https://i.imgur.com/wyeHbRo.png", id:"aguinaldotristanjames"},
  {name:"ãƒªãƒ¼ãƒ»ã‚¦ã‚§ã‚¤ã‚¼(WEIZE)", img:"https://i.imgur.com/XNeHaaX.png", id:"liweize"},
  {name:"ãƒ¨ãƒãƒ³ãƒ»ã‚¨ãƒãƒ‹ãƒ¥ã‚¨ãƒ«(YOHAN)", img:"https://i.imgur.com/RTVMTCA.png", id:"yohanemmanuel"},
  {name:"çŸ¢ç”° ä½³æš‰(YOSHIKI)", img:"https://i.imgur.com/MZbSVDq.png", id:"yadayoshiki"},
  {name:"å¾Œè—¤ çµ(YUKI)", img:"https://i.imgur.com/GZTdD57.png", id:"gotoyuki"},
  {name:"å²¡ç”° ä¾‘ç£¨(YUMA)", img:"https://i.imgur.com/3hhNQLj.png", id:"okadayuma"},
  {name:"å®‰éƒ¨ çµè˜­(YURA)", img:"https://i.imgur.com/pbC301p.png", id:"abeyura"},
  {name:"å¤§æ— æ‚ æˆ(O.YUSEI)", img:"https://i.imgur.com/tp1fKqI.png", id:"obayashiyusei"},
  {name:"ä½é‡ ç”±å¾(S.YUSEI)", img:"https://i.imgur.com/fDql5Tu.png", id:"sanoyusei"},
  {name:"æ¿å€‰ æ‚ å¤ª(YUTA)", img:"https://i.imgur.com/j6IlxeD.png", id:"itakurayuta"}
];

const candidates = [
  {name:"æœ¬è˜ æ™ƒ(AKIRA)", img:"https://i.imgur.com/p976l8j.jpeg", id:"honjoakira"},
  {name:"å…å³¶ æ­©å¤¢(K.AYUMU)", img:"https://i.imgur.com/1jtcgbB.png", id:"kojimaayumu"},
  {name:"å¸‚å· å¤§è¼(I.DAIKI)", img:"https://i.imgur.com/72FqxLz.png", id:"ichikawadaiki"},
  {name:"å·æ‘ ç€æ–—(HAKUTO)", img:"https://i.imgur.com/ua7RMig.png", id:"kawamurahakuto"},
  {name:"æ‘æ¾ é¼ç©º(HARUKU)", img:"https://i.imgur.com/3JEtKs6.png", id:"muramatsuharuku"},
  {name:"é«™åŸ æš–äºº(HARUTO)", img:"https://i.imgur.com/qdXIOpr.png", id:"takagiharuto"},
  {name:"å¹³å³¶ è¼(H.HIKARU)", img:"https://i.imgur.com/P5gzRZh.png", id:"hirashimahikaru"},
  {name:"æ«»äº• è¼(S.HIKARU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sakuraihikaru"}, /* â˜…è¾é€€ */
  {name:"ä½å· å¤ªä¸€(HIROKAZU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sagawahirokazu"},
  {name:"ã‚¤ãƒ»ãƒ’ãƒ§ãƒ³ã‚¸ã‚§(HYUNJAE)", img:"https://i.imgur.com/wOhvKDu.png", id:"leehyunjae"},
  {name:"é˜¿éƒ¨ æ¨¹(ITSUKI)", img:"https://i.imgur.com/TaTAc2L.png", id:"abeitsuki"},
  {name:"ã‚¤ãƒ»ã‚¸ãƒ¥ãƒ³ãƒ•ãƒ³(JOONGHOON)", img:"https://i.imgur.com/4utwyOJ.png", id:"leejoonghoon"},
  {name:"ãƒªãƒ¥ã‚¦ãƒ»ã‚«ã‚¤ãƒ(KAICHI)", img:"https://i.imgur.com/FGbdGcI.png", id:"liukaichi"},
  {name:"é»’ï¨‘ è²«æ±°(KANTA)", img:"https://i.imgur.com/j75eoO7.png", id:"kurosakikanta"},
  {name:"é»„ æ•¬çœ(KEISHIN)", img:"https://i.imgur.com/oE7w4D7.png", id:"kokeishin"},
  {name:"é‡¼æŒ å‰æˆ(KINARI)", img:"https://i.imgur.com/GWAtiwS.png", id:"kenmotsukinari"},
  {name:"å°æ¾¤ æ˜‚å¿ƒ(KOSHIN)", img:"https://i.imgur.com/pn0zB7F.png", id:"ozawakoshin"},
  {name:"é’æ²¼ æ˜‚å²æœ—(KOSHIRO)", img:"https://i.imgur.com/MDhTcs8.png", id:"aonumakoshiro"},
  {name:"å°æ— å»£(KOU)", img:"https://i.imgur.com/RAoUIhC.png", id:"kobayashikou"},
  {name:"æ£® æ˜è‚²(MEI)", img:"https://i.imgur.com/eR0BZVs.png", id:"morimei"},
  {name:"ãƒã‚¤ã‚±ãƒ« ãƒŸãƒ³ãƒ»ãƒã‚«ãƒ•ãƒª(MICHAEL MINH)", img:"https://i.imgur.com/6S8BWAA.png", id:"michaelminhmccaffrey"},
  {name:"ãƒ‘ãƒˆãƒªãƒƒã‚¯ ãƒ•ã‚¡ãƒ³ãƒ»ãƒ¬(PATRICK)", img:"https://i.imgur.com/YRvJQYc.png", id:"patrickphanle"},
  {name:"ç¬ åŸ è“®(KA.REN)", img:"https://i.imgur.com/ZLgNm7o.png", id:"kasahararen"},
  {name:"æ±Ÿå£ è“®ç¿”(E.RENTO)", img:"https://i.imgur.com/ewXd8NH.png", id:"eguchirento"},
  {name:"å°æ— è“®ç¿”(K.RENTO)", img:"https://i.imgur.com/t2NbxIU.png", id:"kobayashirento"},
  {name:"è½åˆ åˆ©æ¸©(RIO)", img:"https://i.imgur.com/HdTZUdu.png", id:"ochiairio"},
  {name:"æ°´ä¸Š ç‰å‰(M.RUI)", img:"https://i.imgur.com/DiUA9bw.png", id:"mizugamirui"},
  {name:"å°è°·å†… ç‘ å˜‰(RUKA)", img:"https://i.imgur.com/V2XnsQ6.png", id:"koyauchiruka"},
  {name:"é½Šè—¤ æƒº(SEI)", img:"https://i.imgur.com/9HIRvNd.png", id:"saitosei"},
  {name:"è—¤æœ¬ çœŸæˆ(SHINSEI)", img:"https://i.imgur.com/qTooOuS.png", id:"fujimotoshinsei"},
  {name:"é£¯ç”° æŸŠé¦¬(SHUMA)", img:"https://i.imgur.com/awBBn6j.png", id:"iidashuma"},
  {name:"æ¾ç”° é¢¯å¾(SOGO)", img:"https://i.imgur.com/Y1MQK3k.png", id:"matsudasogo"},
  {name:"é«™æ©‹ ç©ºè‰¯(T.SORA)", img:"https://i.imgur.com/czFpgjm.png", id:"takahashisora"},
  {name:"è¥¿ç”° é¢¯æ¢“(SOSHI)", img:"https://i.imgur.com/51RMIB6.png", id:"nishidasoshi"},
  {name:"å²¡æœ¬ æ‹“å£«(O.TAKUTO)", img:"https://i.imgur.com/TGP6sbe.png", id:"okamototakuto"},
  {name:"å¤§æ¾¤ ä½‘å†´(YUGO)", img:"https://i.imgur.com/5Gg1E1M.png", id:"osawayugo"},
  {name:"è—¤äº• é›„è–(F.YUSEI)", img:"https://i.imgur.com/prsNOtG.png", id:"fujiiyusei"},
  {name:"å²¡æœ¬ ä½‘æ–—(YUTO)", img:"https://i.imgur.com/lzv8Vu5.png", id:"okamotoyuto"}
];

const trainees = traineesOnly.concat(candidates);
const TRAINEES_COUNT = traineesOnly.length;

let selected = loadSelected();

/* ãƒãƒŠãƒ¼ç”»åƒåæ˜  */
(function setupBanners(){
  const banner = document.getElementById("banner");
  const exportBanner = document.getElementById("exportBanner");
  if(HEADER_IMAGE_URL){
    banner.classList.add("hasImage");
    banner.style.backgroundImage = "url('" + HEADER_IMAGE_URL + "')";
    exportBanner.style.backgroundImage = "url('" + HEADER_IMAGE_URL + "')";
  }
})();

/* ===== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ¯å›è¡¨ç¤ºï¼‰ ===== */
function openIntro(){
  const m = document.getElementById("introModal");
  if(!m) return;
  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
}
function closeIntro(){
  const m = document.getElementById("introModal");
  if(!m) return;
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
}
document.addEventListener("click", (e) => {
  const m = document.getElementById("introModal");
  if(!m || !m.classList.contains("show")) return;
  if(e.target === m) closeIntro();
});
document.addEventListener("keydown", (e) => {
  if(e.key !== "Escape") return;
  const m = document.getElementById("introModal");
  if(m && m.classList.contains("show")) closeIntro();
});

/* ===== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—2ãƒšãƒ¼ã‚¸ ===== */
let introPage = 1;
function showIntroPage(n){
  const pages = Array.from(document.querySelectorAll("#introBody .introPage"));
  const max = pages.length || 2;
  introPage = Math.max(1, Math.min(max, n));

  pages.forEach(p=>{
    const pn = parseInt(p.getAttribute("data-page"), 10);
    p.classList.toggle("isActive", pn === introPage);
  });

  const pagerText = document.getElementById("pagerText");
  if(pagerText) pagerText.textContent = `${introPage}/${max}`;

  const dots = Array.from(document.querySelectorAll("#pagerDots .dot"));
  dots.forEach((d, i)=> d.classList.toggle("isOn", (i+1) === introPage));
}
function introNext(){ showIntroPage(introPage + 1); }
function introPrev(){ showIntroPage(introPage - 1); }

/* ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒšãƒ¼ã‚¸ç§»å‹• */
(function enableIntroSwipe(){
  const box = document.querySelector("#introModal .introBox");
  if(!box) return;

  let startX = 0;
  let startY = 0;
  let active = false;

  box.addEventListener("touchstart", (e)=>{
    if(!e.touches || e.touches.length !== 1) return;
    active = true;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }, {passive:true});

  box.addEventListener("touchend", (e)=>{
    if(!active) return;
    active = false;

    const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
    if(!t) return;

    const dx = t.clientX - startX;
    const dy = t.clientY - startY;

    if(Math.abs(dy) > Math.abs(dx)) return;

    const TH = 42;
    if(dx <= -TH) introNext();
    if(dx >=  TH) introPrev();
  }, {passive:true});
})();

/* ===== ç©ºãæ ï¼ˆæ‰‹å‹•ï¼‰ ===== */
function loadFreeSlots(){
  try{
    const v = parseInt(localStorage.getItem(FREE_SLOTS_KEY), 10);
    if(Number.isFinite(v) && v >= 0 && v <= 10) return v;
  }catch(e){}
  return 0;
}
function saveFreeSlots(){
  try{ localStorage.setItem(FREE_SLOTS_KEY, String(freeSlots)); }catch(e){}
}
function updateFreeButtons(){
  document.querySelectorAll(".freeBtn").forEach(b=>{
    const n = parseInt(b.getAttribute("data-n"), 10);
    b.classList.toggle("freeBtnActive", n === freeSlots);
  });
}
function setFreeSlots(n){
  if(!Number.isInteger(n) || n < 1 || n > 10) return;
  freeSlots = n;
  saveFreeSlots();
  updateFreeButtons();
  renderFreeSlots();
  drawExportPicks();
}

/* â˜…ç©ºãæ è¡¨ç¤ºï¼ˆè‡ªå‹•è¨ˆç®—ã—ãªã„ï¼‰ */
function renderFreeSlots(){
  const t = `ç©ºã ${freeSlots} æ `;
  document.getElementById("slotBadge").textContent = t;
  document.getElementById("exportSlotsText").textContent = t;
  document.getElementById("exportSlotsSentence").textContent = `${freeSlots} æŠ•ç¥¨æ  ç©ºã„ã¦ã„ã¾ã™`;
  renderMissingSlots();
}

/* ===== ç”»é¢ï¼šé¸æŠæ ï¼ˆï¼‹è¡¨ç¤ºã‚ã‚Šï¼‰ ===== */
function drawPicks(){
  const row = document.getElementById("picksRow");
  row.innerHTML = "";

  for(let i=0; i<MAX_SELECTED; i++){
    const slot = document.createElement("div");

    if(i < selected.length){
      const ti = selected[i];
      const m = trainees[ti];
      const c = getColorForTraineeIndex(ti);
      const isTarget = perSlotColorMode && (colorTargetPos === i);

      slot.className = "slot" + (isTarget ? " colorTarget" : "");
      slot.innerHTML = `
        <div class="avatar" style="border-color:${c}"
             onclick="${perSlotColorMode ? `setColorTarget(${i})` : `editHandle(${i})`}">
          <img src="${m.img || FALLBACK_IMG}" alt="">
          <div class="rank" style="background:${c}">${i + 1}</div>
        </div>
        <div class="name" onclick="editHandle(${i})">${displayName(m.name)}</div>
        <div class="reorder">
          <button type="button" onclick="event.stopPropagation(); moveLeft(${i})">â†</button>
          <button type="button" onclick="event.stopPropagation(); moveRight(${i})">â†’</button>
        </div>
      `;
    }else{
      slot.className = "slot empty";
      slot.innerHTML = `<div class="avatar">+</div>`;
    }
    row.appendChild(slot);
  }
}

/* ===== ä¸€è¦§ï¼š2åˆ—ã‚«ãƒ¼ãƒ‰ï¼‹profileï¼ˆè¾é€€ã¯é¸æŠä¸å¯ï¼‰ ===== */
function drawMembers(){
  const q = (document.getElementById("search").value || "").trim().toLowerCase();
  const membersEl = document.getElementById("members");
  membersEl.innerHTML = "";

  const start = showingCandidates ? TRAINEES_COUNT : 0;
  const end   = showingCandidates ? trainees.length : TRAINEES_COUNT;

  for(let i=start; i<end; i++){
    const m = trainees[i];
    if(q && (m.name||"").toLowerCase().indexOf(q) === -1) continue;

    const isWithdrawn = WITHDRAWN_IDS.has(m.id);
    const card = document.createElement("div");
    card.className = "memberCard"
      + (selected.indexOf(i) !== -1 ? " selected" : "")
      + (isWithdrawn ? " withdrawn" : "");

    const purl = profileUrlById(m.id);

    card.innerHTML = `
      <div class="memberCardThumb">
        <img src="${m.img || FALLBACK_IMG}" alt="">
        ${isWithdrawn ? `<div class="withdrawnBadge">â€»è¾é€€</div>` : ``}
      </div>
      <div class="memberCardName">${displayName(m.name)}</div>
      <div class="memberCardSub">${alphaPart(m.name)}</div>
      <a class="memberCardProfile" href="${purl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">profile</a>
    `;

    if(!isWithdrawn){
      card.addEventListener("click", () => add(i));
    }
    membersEl.appendChild(card);
  }
}

/* ç·´ç¿’ç”Ÿ/å€™è£œåˆ‡æ›¿ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¶­æŒï¼‰ */
function toggleCandidates(e){
  if(e && e.preventDefault) e.preventDefault();
  const wrap = document.getElementById("membersWrap");
  const listScroll = wrap ? wrap.scrollTop : 0;
  const winY = window.scrollY;

  showingCandidates = !showingCandidates;
  document.getElementById("toggleListBtn").textContent = showingCandidates ? "ç·´ç¿’ç”Ÿ" : "ç·´ç¿’ç”Ÿå€™è£œ";

  drawMembers();

  requestAnimationFrame(function(){
    if(wrap) wrap.scrollTop = listScroll;
    window.scrollTo(0, winY);
  });
}

function add(i){
  if(selected.length >= MAX_SELECTED){ alert(MAX_SELECTED + "äººã¾ã§ï¼"); return; }
  if(selected.indexOf(i) !== -1) return;

  const m = trainees[i];
  if(m && WITHDRAWN_IDS.has(m.id)) return;

  withMembersScrollLock(() => {
    selected.push(i);
    saveSelected();
    drawPicks();
    drawMembers();
    drawExportPicks();
  });
}
function undo(){
  withMembersScrollLock(() => {
    selected.pop();
    saveSelected();
    // æ åˆ¥ãƒ¢ãƒ¼ãƒ‰ã§ã€å¯¾è±¡ãŒæ¶ˆãˆãŸã‚‰è§£é™¤
    if(colorTargetPos !== null && colorTargetPos >= selected.length) colorTargetPos = null;
    drawPicks();
    drawMembers();
    drawExportPicks();
  });
}
function resetAll(){
  withMembersScrollLock(() => {
    selected = [];
    saveSelected();

    freeSlots = 0;
    saveFreeSlots();

    handles = {};
    saveHandles();

    slotColors = {};
    saveSlotColors();

    perSlotColorMode = false;
    colorTargetPos = null;
    const cm = document.getElementById("colorModeBtn");
    if(cm) cm.textContent = "è‰²å¤‰æ›´ï¼šå…¨å“¡";

    setAccentColor("#0080ff");

    drawPicks();
    drawMembers();
    updateFreeButtons();
    drawExportPicks();
    renderFreeSlots();
  });
}

/* ä¸¦ã³æ›¿ãˆ */
let reorderMode = false;
function toggleReorder(){
  reorderMode = !reorderMode;
  document.body.classList.toggle("reorder-on", reorderMode);
  document.getElementById("reorderBtn").textContent = "ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼š" + (reorderMode ? "ON" : "OFF");
}
function swap(a,b){
  if(a<0||b<0||a>=selected.length||b>=selected.length) return;
  withMembersScrollLock(() => {
    const t = selected[a]; selected[a]=selected[b]; selected[b]=t;
    saveSelected();
    // æ åˆ¥ãƒ¢ãƒ¼ãƒ‰ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½®ã‚‚è¿½å¾“
    if(colorTargetPos === a) colorTargetPos = b;
    else if(colorTargetPos === b) colorTargetPos = a;

    drawPicks(); drawMembers(); drawExportPicks();
  });
}
function moveLeft(pos){ swap(pos, pos-1); }
function moveRight(pos){ swap(pos, pos+1); }

function saveSelected(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(selected)); }catch(e){}
}
function loadSelected(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr.filter(n => Number.isInteger(n)) : [];
  }catch(e){ return []; }
}

/* ======= ä¿å­˜ç”»åƒã®ä¸¦ã³ãƒ«ãƒ¼ãƒ«ï¼ˆé¸æŠäººæ•°åŸºæº–ï¼‰ ======= */
function exportPlanBySelectedCount(count){
  if(count <= 0) return [0,0];
  if(count <= 4) return [count, 0];
  if(count === 5) return [2,3];
  if(count === 6) return [3,3];
  if(count === 7) return [3,4];
  if(count === 8) return [4,4];
  if(count === 9) return [4,5];
  if(count === 10) return [5,5];
  if(count === 11) return [5,6];
  return [Math.min(5,count), Math.max(0,count-5)];
}

/* â€œå°‘ã—å°ã•ãâ€ è‡ªå‹•èª¿æ•´ */
function fitExportAvatar(count){
  const plan = exportPlanBySelectedCount(count);
  const maxCols = Math.max(plan[0], plan[1]);

  const availableW = 1004 - 56*2;
  const minAvatar = 96;
  let avatar = 112;
  let gapX = 56;

  if(maxCols <= 1){
    setExportVars(avatar, gapX, 30, 15);
    return;
  }

  while(true){
    const needW = avatar*maxCols + gapX*(maxCols-1);
    if(needW <= availableW) break;
    if(avatar <= minAvatar) break;
    avatar -= 2;
    gapX = Math.max(32, gapX - 2);
  }

  const border = Math.max(6, Math.round(avatar/14));
  document.documentElement.style.setProperty("--exBorder", border + "px");

  const name = Math.max(13, Math.min(15, Math.round(avatar/7.5)));
  setExportVars(avatar, gapX, 28, name);
}
function setExportVars(avatar, gapX, gapY, nameSize){
  document.documentElement.style.setProperty("--exAvatar", avatar + "px");
  document.documentElement.style.setProperty("--exGapX", gapX + "px");
  document.documentElement.style.setProperty("--exGapY", gapY + "px");
  document.documentElement.style.setProperty("--exName", nameSize + "px");
}

/* ä½™ç™½èª¿æ•´ï¼ˆåŸºæœ¬ï¼‰ */
function adjustExportLayoutBase(count, r2){
  let topH = 470;
  if(r2 === 0){
    if(count <= 2) topH = 320;
    else if(count <= 4) topH = 360;
    else topH = 400;
  }else{
    if(count <= 7) topH = 440;
    else topH = 470;
  }
  document.documentElement.style.setProperty("--exTopH", topH + "px");

  let padTop = 16;
  if(count <= 2) padTop = 0;
  else if(count <= 4) padTop = 6;
  else if(count <= 7) padTop = 12;
  else padTop = 16;
  document.documentElement.style.setProperty("--exBottomPadTop", padTop + "px");

  document.documentElement.style.setProperty("--exBottomPadBottom", "150px");

  let missTop = 18;
  if(count <= 2) missTop = 8;
  else if(count <= 4) missTop = 12;
  else missTop = 18;
  document.documentElement.style.setProperty("--exMissTop", missTop + "px");

  document.documentElement.style.setProperty("--exMissSize", "120px");
  document.documentElement.style.setProperty("--exMissRowMinH", "130px");
  document.documentElement.style.setProperty("--exMissGapY", "12px");

  document.documentElement.style.setProperty("--exSentence", "20px");
}

/* â˜…@ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å…¨å“¡åŒã˜ã«æƒãˆã‚‹ */
function setExportHandleSize(px){
  document.documentElement.style.setProperty("--exHandle", px + "px");
}
function fitExportHandlesUniform(){
  const els = Array.from(document.querySelectorAll("#exportInner .exportHandle"));
  if(!els.length) return;

  const MAX = 13;
  const MIN = 10;

  setExportHandleSize(MAX);

  const targets = els.filter(el => {
    const t = (el.textContent || "").trim();
    return t && t !== "";
  });

  if(!targets.length){
    setExportHandleSize(MAX);
    return;
  }

  for(let size = MAX; size >= MIN; size--){
    setExportHandleSize(size);

    const ok = targets.every(el => el.scrollWidth <= el.clientWidth);
    if(ok) return;
  }

  setExportHandleSize(MIN);
}

/* â˜…ä¸‹ã®æ–‡ãŒã‚¬ãƒ©ã‚¹æ ã¨çµ¶å¯¾è¢«ã‚‰ãªã„ã‚ˆã†ã« */
function setExportSentenceSize(px){
  document.documentElement.style.setProperty("--exSentence", px + "px");
}
function preventFooterOverlap(){
  const sentence = document.getElementById("exportSlotsSentence");
  const tiktok = document.getElementById("exportTikTok");
  const hashtag = document.getElementById("exportHashtag");
  if(!sentence || !tiktok || !hashtag) return;

  const limitTop = Math.min(tiktok.getBoundingClientRect().top, hashtag.getBoundingClientRect().top) - 10;

  let missSize = 120;
  let rowMinH = 130;
  let gapY = 12;

  for(let k=0;k<12;k++){
    const sRect = sentence.getBoundingClientRect();
    if(sRect.bottom <= limitTop) break;

    missSize = Math.max(82, missSize - 4);
    rowMinH = Math.max(92, rowMinH - 4);
    gapY = Math.max(6, gapY - 1);

    document.documentElement.style.setProperty("--exMissSize", missSize + "px");
    document.documentElement.style.setProperty("--exMissRowMinH", rowMinH + "px");
    document.documentElement.style.setProperty("--exMissGapY", gapY + "px");
  }

  for(let size=20; size>=16; size--){
    setExportSentenceSize(size);
    const sRect = sentence.getBoundingClientRect();
    if(sRect.bottom <= limitTop) break;
  }
}

/* ===== ä¿å­˜ï¼šä¸Šã«é¸æŠã ã‘ï¼ä¸‹ã«ç©ºãæ ã‚’2æ®µã§å¿…ãšå‡ºã™ ===== */
function drawExportPicks(){
  const row1 = document.getElementById("exportRow1");
  const row2 = document.getElementById("exportRow2");
  row1.innerHTML = "";
  row2.innerHTML = "";

  const count = selected.length;
  const plan = exportPlanBySelectedCount(count);
  const r1 = plan[0], r2 = plan[1];

  fitExportAvatar(count);

  const hasAnyHandle = selected.some(idx => (handles[String(idx)] || "").trim());
  if(r2 > 0 && hasAnyHandle){
    document.documentElement.style.setProperty("--exGapY", "38px");
  }

  for(let i=0;i<r1;i++){
    row1.appendChild(makeExportSlot(trainees[selected[i]], i));
  }
  if(r2 > 0){
    row2.style.display = "flex";
    for(let j=0;j<r2;j++){
      const idx = r1 + j;
      row2.appendChild(makeExportSlot(trainees[selected[idx]], idx));
    }
  }else{
    row2.style.display = "none";
  }

  renderFreeSlots();
  renderMissingSlots();

  adjustExportLayoutBase(count, r2);

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      fitExportHandlesUniform();
      preventFooterOverlap();
    });
  });
}

/* â˜…ä¿å­˜ç”»åƒï¼šæ åˆ¥ã‚«ãƒ©ãƒ¼åæ˜  */
function makeExportSlot(m, orderIndex){
  const traineeIndex = selected[orderIndex];
  const handle = (handles[String(traineeIndex)] || "").trim();
  const c = getColorForTraineeIndex(traineeIndex);

  const d = document.createElement("div");
  d.className = "exportSlot";
  d.innerHTML = `
    <div class="exportAvatar" style="border-color:${c}">
      <div class="exportPhoto" style="background-image:url('${(m && m.img) ? m.img : FALLBACK_IMG}')"></div>
      <div class="exportRank" style="background:${c}">${orderIndex + 1}</div>
    </div>
    <div class="exportName">${displayName(m && m.name ? m.name : "")}</div>
    <div class="exportHandle">${handle ? handle : "&nbsp;"}</div>
  `;
  return d;
}

/* ç©ºãæ ï¼ˆfreeSlotsï¼‰ã‚’2æ®µã«å‰²ã£ã¦æç”» */
function planMissingRows(n){
  if(n <= 0) return [0,0];
  const first = Math.floor(n / 2);
  const second = n - first;
  return [first, second];
}

function renderMissingSlots(){
  const row1 = document.getElementById("exportMissingRow1");
  const row2 = document.getElementById("exportMissingRow2");
  if(!row1) return;

  row1.innerHTML = "";
  if(row2) row2.innerHTML = "";

  const n = Math.max(0, freeSlots);
  const [a,b] = planMissingRows(n);

  for(let i=0;i<a;i++){
    const d = document.createElement("div");
    d.className = "missingIcon";
    row1.appendChild(d);
  }

  if(row2){
    row2.style.display = (b > 0) ? "flex" : "none";
    for(let i=0;i<b;i++){
      const d = document.createElement("div");
      d.className = "missingIcon";
      row2.appendChild(d);
    }
  }
}

/* ä¿å­˜ */
async function saveImage(){
  if(typeof html2canvas === "undefined"){
    alert("ç”»åƒä¿å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    return;
  }

  drawExportPicks();

  const toast = document.getElementById("toast");
  toast.style.display = "block";

  try{
    const target = document.getElementById("exportInner");
    const canvas = await html2canvas(target, {
      backgroundColor:"#ffffff",
      useCORS:true,
      allowTaint:false,
      scale: 5
    });
    const link = document.createElement("a");
    link.download = "oshivote_1004x1040.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }catch(e){
    alert("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒURLå´ã®åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
  }finally{
    toast.style.display = "none";
  }
}

/* åˆæœŸæç”» */
(function initAll(){
  openIntro();
  showIntroPage(1);

  // åˆæœŸï¼šä¿å­˜ã—ã¦ã‚ã‚‹å…¨ä½“è‰²ã‚’åæ˜ ï¼ˆæœªè¨­å®šæ ã¯ã“ã‚ŒãŒä½¿ã‚ã‚Œã‚‹ï¼‰
  const savedAccent = loadAccentColor();
  applyAccentColor(savedAccent);

  // è‰²ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³åˆæœŸ
  const cm = document.getElementById("colorModeBtn");
  if(cm) cm.textContent = "è‰²å¤‰æ›´ï¼šå…¨å“¡";

  updateFreeButtons();
  drawPicks();
  drawMembers();
  drawExportPicks();
  renderFreeSlots();
})();
</script>
</body>
</html>
